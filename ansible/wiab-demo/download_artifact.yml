- name: Download wire artifact
  hosts: deploy_node
  become: yes
  become_user: "{{ ansible_user }}"  
  tasks:
  - name: create wire-server-deploy directory for {{ ansible_user }} user
    file:
      path: "{{ ansible_user_dir }}/wire-server-deploy"
      state: directory
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: 0755

  - name: check if wire-server-deploy-static-demo-{{ artifact_hash }}.tgz exists
    stat:
      path: "{{ ansible_user_dir }}/wire-server-deploy-static-demo-{{ artifact_hash }}.tgz"
      get_checksum: False
    register: artifact_archive_file_check

  - name: download wire-server-deploy archive
    shell:
      cmd: curl -fsSLo "{{ ansible_user_dir }}/wire-server-deploy-static-demo-{{ artifact_hash }}.tgz" https://s3-eu-west-1.amazonaws.com/public.wire.com/artifacts/wire-server-deploy-static-demo-{{ artifact_hash }}.tgz
      creates: "{{ ansible_user_dir }}/wire-server-deploy-static-demo-{{ artifact_hash }}.tgz"
    when: not artifact_archive_file_check.stat.exists
    register: artifact_archive
    async: 1200
    poll: 0

  - name: Waiting on async task artifact_archive
    async_status:
      jid: "{{ artifact_archive.ansible_job_id }}"
    register: res
    until: res.finished
    retries: 20
    delay: 60
    when: not artifact_archive_file_check.stat.exists

  - name: check if wire-server-deploy folder contents exist
    stat:
      path: "{{ ansible_user_dir }}/wire-server-deploy/containers-helm.tar"
      get_checksum: False
    register: artifact_folder_content_check

  - name: Unpack wire-server-deploy archive, will take a few mins - grab a coffee
    unarchive:
      src: "{{ ansible_user_dir }}/wire-server-deploy-static-demo-{{ artifact_hash }}.tgz"
      dest: "{{ ansible_user_dir }}/wire-server-deploy"
      remote_src: yes
    when: not artifact_folder_content_check.stat.exists

  - name: Ensure directory exists and set permissions
    file:
      path: "{{ ansible_user_dir }}/wire-server-deploy"
      state: directory
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: '0775'
      recurse: yes
      follow: no
    ignore_errors: yes
