# ===================================================================
# PostgreSQL Deployment Pipeline
# ===================================================================
# This playbook orchestrates PostgreSQL cluster deployment.
# Playbooks run in strict order due to dependencies.
#
# Dependency Chain:
#   backup → cleanup → install → secrets → primary → replica → verify → wire-setup → monitoring
#   (backup should run before cleanup to create safety backup)
#
# Tag Strategy:
#   - Use --skip-tags to exclude specific steps
#   - Do NOT use --tags to run individual steps (will break dependencies)
#   - Recommended: Run full playbook or use skip-tags
#
# Usage Examples:
#   Full deployment(Backs up existing data, cleans up the previous state if any, sets up HA pg cluster, deploy the guard against split-brain issues and sets up wire-server DB):    ansible-playbook -i <inventory_file> postgresql-deploy.yml
#   Skip backup(not recommended):       ansible-playbook -i <inventory_file> postgresql-deploy.yml --skip-tags backup
#   Skip cleanup(cleans up the previous repmgr state and re-initializes the database as new state):       ansible-playbook -i <inventory_file> postgresql-deploy.yml --skip-tags cleanup
#   Skip monitoring(In general this step should not be skipped as it sets up the guard against split-brain issues):    ansible-playbook -i <inventory_file> postgresql-deploy.yml --skip-tags monitoring
#   Skip wire-setup (sets up the wire-server database and user):    ansible-playbook -i <inventory_file> postgresql-deploy.yml --skip-tags wire-setup
#
#
# To run from a specific point, comment out earlier playbooks.
# ===================================================================

- name: Backup all PostgreSQL nodes before cleanup
  import_playbook: postgresql-playbooks/postgresql-backup.yml
  tags: [postgresql, backup]
  # Creates safety backup to assethost before destructive cleanup operations

- name: Clean repmgr HA cluster configuration
  import_playbook: postgresql-playbooks/postgresql-cleanup.yml
  tags: [postgresql, cleanup]

- name: Install PostgreSQL packages
  import_playbook: postgresql-playbooks/postgresql-install.yml
  tags: [postgresql, install]

- name: Setup PostgreSQL passwords from Kubernetes Secrets
  import_playbook: postgresql-playbooks/postgresql-secrets.yml
  tags: [postgresql, secrets]
  # Sets facts: repmgr_password, wire_pass (required by all following playbooks)

- name: Deploy PostgreSQL primary node
  import_playbook: postgresql-playbooks/postgresql-deploy-primary.yml
  tags: [postgresql, primary]
  # Requires: repmgr_password

- name: Deploy PostgreSQL replica nodes
  import_playbook: postgresql-playbooks/postgresql-deploy-replica.yml
  tags: [postgresql, replica]
  # Requires: repmgr_password

- name: Verify PostgreSQL deployment
  import_playbook: postgresql-playbooks/postgresql-verify-HA.yml
  tags: [postgresql, verify]

- name: Setup wire-server postgresql database and user
  import_playbook: postgresql-playbooks/postgresql-wire-setup.yml
  tags: [postgresql, wire-setup]
  # Requires: wire_pass

- name: Deploy cluster monitoring
  import_playbook: postgresql-playbooks/postgresql-monitoring.yml
  tags: [postgresql, monitoring]

- name: Deploy PostgreSQL metrics exporter
  import_playbook: postgresql-playbooks/postgresql-exporter.yml
  tags: [postgresql, metrics, exporter]
