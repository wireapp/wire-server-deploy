# PostgreSQL Configuration for Primary Node (Streaming Replication Optimized)
# {{ ansible_managed }}

# Basic Settings
# https://www.postgresql.org/docs/17/runtime-config-file-locations.html
data_directory = '/var/lib/postgresql/{{ postgresql_version }}/main'
hba_file = '/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf'
ident_file = '/etc/postgresql/{{ postgresql_version }}/main/pg_ident.conf'
external_pid_file = '/var/run/postgresql/{{ postgresql_version }}-main.pid'

# Connection Settings
# https://www.postgresql.org/docs/17/runtime-config-connection.html
listen_addresses = '*'
port = 5432
max_connections = 20                      
superuser_reserved_connections = 2
shared_preload_libraries = 'pg_stat_statements'

# Memory Settings (optimized for 1GB RAM, 1 core)
https://www.postgresql.org/docs/17/runtime-config-resource.html
shared_buffers = 128MB                    # ~12.5% of total RAM (conservative for limited memory)
effective_cache_size = 512MB              # ~50% of total RAM for OS cache
work_mem = 2MB                            # Limited for constrained memory
maintenance_work_mem = 32MB               # Conservative for maintenance operations
wal_buffers = 4MB                         # Smaller WAL buffer
max_worker_processes = 1                  # Match core count
max_parallel_workers = 1                  # Match single core
max_parallel_workers_per_gather = 0        # Disable parallel workers for single core

# Write-Ahead Logging (WAL) - Optimized for 50GB disk constraint
# https://www.postgresql.org/docs/17/runtime-config-wal.html
wal_level = replica
max_wal_senders = 2                       # Limited for resource constraints
max_replication_slots = 2                 # Conservative number of slots
wal_keep_size = 2GB                       # 4% of disk space for WAL retention
wal_sender_timeout = 60s
max_slot_wal_keep_size = 3GB              # 6% of disk space maximum

# WAL Writing and Flushing (for minimal latency)
wal_sync_method = fdatasync
wal_writer_delay = 200ms                   # More frequent WAL writes
wal_writer_flush_after = 1MB
commit_delay = 0                          # No artificial delay
commit_siblings = 5

# Streaming Replication Settings - Asynchronous for resource efficiency
# https://www.postgresql.org/docs/17/runtime-config-replication.html
synchronous_standby_names = ''            # Async replication to reduce resource usage
synchronous_commit = off                  # Async commits for better performance with limited resources
wal_receiver_status_interval = 10s         # Less frequent updates to save resources
max_standby_streaming_delay = 120s         # Longer delays acceptable for resource constraints
max_standby_archive_delay = 120s
hot_standby_feedback = on                 # Prevent query conflicts on replicas

# Checkpoints (optimized for limited disk I/O)
# https://www.postgresql.org/docs/17/runtime-config-wal.html#RUNTIME-CONFIG-WAL-CHECKPOINTS
checkpoint_completion_target = 0.9        # Slower completion for limited I/O
checkpoint_timeout = 15min                # Longer intervals to reduce I/O load  
max_wal_size = 512MB                      # 1% of disk space before checkpoint
min_wal_size = 128MB                      # Reasonable minimum
checkpoint_flush_after = 64kB            # Smaller flushes for limited I/O

# Background Writer
# https://www.postgresql.org/docs/17/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-BACKGROUND-WRITER
bgwriter_delay = 200ms                     # More frequent background writes
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 256kB

# Query Planner
# https://www.postgresql.org/docs/17/runtime-config-query.html#RUNTIME-CONFIG-QUERY-CONSTANTS
random_page_cost = 1.5                    
effective_io_concurrency = 1            
maintenance_io_concurrency = 1

# Logging (focused on replication and queries)
# https://www.postgresql.org/docs/17/runtime-config-logging.html
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 50MB
log_min_duration_statement = 2000         # Log slower queries on replica
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,client=%h,app=%a '
log_statement = 'none'                    # Less logging on replica
log_replication_commands = on             # Monitor replication
log_checkpoints = on
log_connections = off
log_disconnections = off
log_lock_waits = on
log_recovery_conflict_waits = on          # Log recovery conflicts

# Statistics
# https://www.postgresql.org/docs/17/runtime-config-statistics.html#RUNTIME-CONFIG-CUMULATIVE-STATISTICS
track_activities = on
track_counts = on
track_io_timing = off                      # Monitor I/O performance
track_functions = none

# Autovacuum (tuned for resource constraints)
# https://www.postgresql.org/docs/17/routine-vacuuming.html
autovacuum = on
autovacuum_max_workers = 1                # Single worker for single core
autovacuum_naptime = 120s                 # Less frequent for resource conservation
autovacuum_vacuum_threshold = 100         # Higher thresholds
autovacuum_vacuum_scale_factor = 0.2      # Less aggressive
autovacuum_analyze_threshold = 100
autovacuum_analyze_scale_factor = 0.15
autovacuum_work_mem = 16MB                # Reduced memory for autovacuum

# Locale and Formatting
# https://www.postgresql.org/docs/17/locale.html
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'
