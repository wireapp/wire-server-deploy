# PostgreSQL configuration for all PostgreSQL nodes
postgresql_version: 17
postgresql_data_dir: /var/lib/postgresql/{{ postgresql_version }}/main
postgresql_conf_dir: /etc/postgresql/{{ postgresql_version }}/main

# wire-server database configuration
wire_dbname: wire-server
wire_user: wire-server
wire_namespace: default  # Kubernetes namespace for secret storage

# repmgr HA configuration
repmgr_user: repmgr
repmgr_database: repmgr
# Note: repmgr_password is NOT defined here - it's dynamically set by postgresql-secrets.yml
#       The password is fetched from K8s secret or auto-generated during deployment.
#       To manually pre-create: kubectl create secret generic repmgr-postgresql-secret -n <namespace> --from-literal=password=<your-password>

# Kubernetes Secret configuration for repmgr
repmgr_secret_name: "repmgr-postgresql-secret"
repmgr_namespace: "{{ wire_namespace | default('default') }}"

# Kubernetes Secret configuration for wire-server PostgreSQL user
# This is managed alongside repmgr credentials in postgresql-secrets.yml
wire_pg_secret_name: "wire-postgresql-external-secret"

# Node configuration for repmgr
# NOTE: repmgr_node_config is defined in the inventory file ansible/inventory/offline/99-static, ansible/inventory/offline/staging.yml and terraform/examples/wire-server-deploy-offline-hetzner/outputs.tf
# to allow environment-specific node mappings. Do not define here.

# repmgr settings
# repmgrd monitoring and reconnection configuration
# Reference: https://repmgr.org/docs/current/repmgrd-basic-configuration.html
#
# monitor_interval_secs: Interval in seconds between monitoring checks
#   - Default: 2 seconds
#   - Controls how frequently repmgr monitors the primary server status
#
# reconnect_attempts: Maximum number of reconnection attempts
#   - Default: 6 attempts
#   - Number of times repmgr will attempt to reconnect to a failed primary
#
# reconnect_interval: Interval in seconds between reconnection attempts
#   - Default: 10 seconds
#   - Time to wait between each reconnection attempt
monitor_interval_secs: 2
reconnect_attempts: 6
reconnect_interval: 5

# Use local packages instead of repository
postgresql_use_repository: false  # Set to true to use local packages from urls

# PostgreSQL package definitions
# When updating the packages, update the checksums too in wire-server-deploy/nix/pkgs/wire-binaries.nix
postgresql_pkgs:
  - name: libpq5
    url: "{{ binaries_url }}/libpq5_18.1-1.pgdg22.04+2_amd64.deb"
    checksum: "sha256:4ae11bafcf5cb972e53457c01de30bd4119e8ed280bced0c383aceecb06b4be8"
  - name: postgresql-client-common
    url: "{{ binaries_url }}/postgresql-client-common_287.pgdg22.04+1_all.deb"
    checksum: "sha256:7e96dbd09f546e819806d6897a6e8a08b0ffe544990d52a82f3e84cad1fac775"
  - name: postgresql-common
    url: "{{ binaries_url }}/postgresql-common_287.pgdg22.04+1_all.deb"
    checksum: "sha256:f8909773a26c0d189db0331b4efa3909d31f1b6bcc9c663904f73efbcb48c642"
  - name: postgresql-client-17
    url: "{{ binaries_url }}/postgresql-client-17_17.7-3.pgdg22.04+1_amd64.deb"
    checksum: "sha256:c6443fefb733632ee835a53b43a174244a009c62ac46bf01f032738b7ff18a8e"
  - name: postgresql-17
    url: "{{ binaries_url }}/postgresql-17_17.7-3.pgdg22.04+1_amd64.deb"
    checksum: "sha256:8218af27440df4e1cd29eeb0fffdcf0702fb50840ccbefd19864355237a0cddf"
  - name: python3-psycopg2
    url: "{{ binaries_url }}/python3-psycopg2_2.9.10-1.pgdg22.04+1_amd64.deb"
    checksum: "sha256:cc2f749e3af292a67e012edeb4aa5d284f57f2d66a9a09fe5b81e5ffda73cab4"
  - name: repmgr-common
    url: "{{ binaries_url }}/repmgr-common_5.5.0+debpgdg-3.pgdg22.04+1_all.deb"
    checksum: "sha256:f559920df00e4d66cb41d73a6f918bbd2cc99c238db97c675a060305f9e05531"
  - name: repmgr
    url: "{{ binaries_url }}/repmgr_5.5.0+debpgdg-3.pgdg22.04+1_all.deb"
    checksum: "sha256:f4efae9acf2fbfb5f5af43b8b812e2925d611fca1c48925276abc64116766128"
  - name: postgresql-17-repmgr
    url: "{{ binaries_url }}/postgresql-17-repmgr_5.5.0+debpgdg-3.pgdg22.04+1_amd64.deb"
    checksum: "sha256:d8c2d333d7444b88a28f9f1cc8cf351a1120b8856a26940b21e256f80deefd84"